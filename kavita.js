var e=this&&this.__assign||function(){return e=Object.assign||function(e){for(var t,i=1,a=arguments.length;i<a;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},e.apply(this,arguments)},t=this&&this.__awaiter||function(e,t,i,a){return new(i||(i=Promise))((function(r,n){function s(e){try{l(a.next(e))}catch(e){n(e)}}function o(e){try{l(a.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}l((a=a.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var i,a,r,n={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(l){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(n=0)),n;)try{if(i=1,a&&(r=2&o[0]?a.return:o[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,o[1])).done)return r;switch(a=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,a=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if(!(r=n.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){n=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){n.label=o[1];break}if(6===o[0]&&n.label<r[1]){n.label=r[1],r=o;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(o);break}r[2]&&n.ops.pop(),n.trys.pop();continue}o=t.call(e,n)}catch(e){o=[6,e],a=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}};Object.defineProperty(exports,"__esModule",{value:!0});var a,r,n,s,o=require("@libs/fetch"),l=require("@libs/filterInputs"),u=require("@libs/novelStatus"),c=require("@libs/defaultCover"),p=require("@libs/storage");!function(e){e[e.Equal=0]="Equal",e[e.GreaterThan=1]="GreaterThan",e[e.GreaterThanEqual=2]="GreaterThanEqual",e[e.LessThan=3]="LessThan",e[e.LessThanEqual=4]="LessThanEqual",e[e.Contains=5]="Contains",e[e.MustContains=6]="MustContains",e[e.Matches=7]="Matches",e[e.NotContains=8]="NotContains",e[e.NotEqual=9]="NotEqual",e[e.BeginsWith=10]="BeginsWith",e[e.EndsWith=11]="EndsWith",e[e.IsBefore=12]="IsBefore",e[e.IsAfter=13]="IsAfter",e[e.IsInLast=14]="IsInLast",e[e.IsNotInLast=15]="IsNotInLast",e[e.IsEmpty=16]="IsEmpty"}(a||(a={})),function(e){e[e.Summary=0]="Summary",e[e.SeriesName=1]="SeriesName",e[e.PublicationStatus=2]="PublicationStatus",e[e.Languages=3]="Languages",e[e.AgeRating=4]="AgeRating",e[e.UserRating=5]="UserRating",e[e.Tags=6]="Tags",e[e.CollectionTags=7]="CollectionTags",e[e.Translators=8]="Translators",e[e.Characters=9]="Characters",e[e.Publisher=10]="Publisher",e[e.Editor=11]="Editor",e[e.Artist=12]="Artist",e[e.Letterer=13]="Letterer",e[e.Colorist=14]="Colorist",e[e.Inker=15]="Inker",e[e.Penciller=16]="Penciller",e[e.Writers=17]="Writers",e[e.Genres=18]="Genres",e[e.Libraries=19]="Libraries",e[e.ReadingProgress=20]="ReadingProgress",e[e.Formats=21]="Formats",e[e.ReleaseYear=22]="ReleaseYear",e[e.ReadTime=23]="ReadTime",e[e.Path=24]="Path",e[e.FilePath=25]="FilePath",e[e.WantToRead=26]="WantToRead",e[e.ReadDate=27]="ReadDate",e[e.AverageRating=28]="AverageRating",e[e.Imprint=29]="Imprint",e[e.Team=30]="Team",e[e.Location=31]="Location",e[e.LastRead=32]="LastRead",e[e.FileSize=33]="FileSize"}(r||(r={})),function(e){e[e.MatchAny=0]="MatchAny",e[e.MatchAll=1]="MatchAll"}(n||(n={})),function(e){e[e.SortName=1]="SortName",e[e.Created=2]="Created",e[e.LastModified=3]="LastModified",e[e.ItemAdded=4]="ItemAdded",e[e.TimeToRead=5]="TimeToRead",e[e.ReleaseYear=6]="ReleaseYear",e[e.LastRead=7]="LastRead",e[e.AverageRating=8]="AverageRating",e[e.Random=9]="Random"}(s||(s={}));var h=function(){function e(e){this._combination=n.MatchAll,this._statements=[],this._sortField=s.SortName,this._sortAscending=!0,this._limitTo=0,this._name=e}return e.prototype.combination=function(e){return this._combination=e,this},e.prototype.sortBy=function(e,t){return void 0===t&&(t=!0),this._sortField=e,this._sortAscending=t,this},e.prototype.limitTo=function(e){return this._limitTo=e,this},e.prototype.whereGenresInclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.Genres,comparison:a.MustContains,value:e.join(",")}),this):this},e.prototype.whereGenresExclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.Genres,comparison:a.NotContains,value:e.join(",")}),this):this},e.prototype.wherePublicationStatusInclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.PublicationStatus,comparison:a.Contains,value:e.join(",")}),this):this},e.prototype.wherePublicationStatusExclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.PublicationStatus,comparison:a.NotContains,value:e.join(",")}),this):this},e.prototype.whereLibrariesInclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.Libraries,comparison:a.Contains,value:e.join(",")}),this):this},e.prototype.whereLibrariesExclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.Libraries,comparison:a.NotContains,value:e.join(",")}),this):this},e.prototype.whereFormatsContains=function(e){return e&&0!==e.length?(this._statements.push({field:r.Formats,comparison:a.Contains,value:e.join(",")}),this):this},e.prototype.whereReleaseYear=function(e,t){var i=null!=t?String(t).trim():"";return i?(this._statements.push({field:r.ReleaseYear,comparison:e,value:i}),this):this},e.prototype.whereSeriesName=function(e,t){var i=(null!=t?t:"").trim();return i?(this._statements.push({field:r.SeriesName,comparison:e,value:i}),this):this},e.prototype.whereWantToRead=function(e){var t="string"==typeof e?e.trim().toLowerCase():e;return!0===t||!1===t?this._statements.push({field:r.WantToRead,comparison:a.Equal,value:t?"true":"false"}):"true"!==t&&"false"!==t||this._statements.push({field:r.WantToRead,comparison:a.Equal,value:t}),this},e.prototype.whereTagsInclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.Tags,comparison:a.MustContains,value:e.join(",")}),this):this},e.prototype.whereTagsExclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.Tags,comparison:a.NotContains,value:e.join(",")}),this):this},e.prototype.whereCollectionTagsInclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.CollectionTags,comparison:a.Contains,value:e.join(",")}),this):this},e.prototype.whereCollectionTagsExclude=function(e){return e&&0!==e.length?(this._statements.push({field:r.CollectionTags,comparison:a.NotContains,value:e.join(",")}),this):this},e.prototype.build=function(){return{name:this._name,combination:this._combination,statements:this._statements,sortOptions:{sortField:this._sortField,isAscending:this._sortAscending},limitTo:this._limitTo}},e}(),d=function(){function r(){var e=this;this.id="kavita-api",this.name="Kavita",this.icon="src/multi/kavita/icon.png",this.version="0.0.8",this.site=p.storage.get("url"),this.apiKey=p.storage.get("apiKey"),this._filtersLoaded=!1,this._presetFilterMap=new Map,this._filters={presetFilter:{label:"Preset filter",type:l.FilterTypes.Picker,options:[{label:"None",value:""}],value:""},filterCombination:{label:"Filter combination",type:l.FilterTypes.Picker,options:[{label:"Match any (OR)",value:String(n.MatchAny)},{label:"Match all (AND)",value:String(n.MatchAll)}],value:String(n.MatchAll)},sortField:{label:"Sort by",type:l.FilterTypes.Picker,options:[{label:"Sort Name",value:String(s.SortName)},{label:"Created",value:String(s.Created)},{label:"Last Modified",value:String(s.LastModified)},{label:"Item Added",value:String(s.ItemAdded)},{label:"Time to Read",value:String(s.TimeToRead)},{label:"Release Year",value:String(s.ReleaseYear)},{label:"Last Read",value:String(s.LastRead)},{label:"Average Rating",value:String(s.AverageRating)},{label:"Random",value:String(s.Random)}],value:String(s.SortName)},sortDirection:{label:"Sort direction",type:l.FilterTypes.Picker,options:[{label:"Ascending",value:"true"},{label:"Descending",value:"false"}],value:"true"},limitTo:{label:"Limit results (0 = no limit)",type:l.FilterTypes.TextInput,value:"0"},libraries:{label:"Libraries",type:l.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}},publicationStatus:{label:"Publication status",type:l.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}},collectionTags:{label:"Collections",type:l.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}},wantToRead:{label:"Want to read",type:l.FilterTypes.Picker,options:[{label:"Any",value:""},{label:"Must be marked",value:"true"},{label:"Must NOT be marked",value:"false"}],value:""},seriesNameComparison:{label:"Series name operator",type:l.FilterTypes.Picker,options:[{label:"Equal",value:String(a.Equal)},{label:"Not equal",value:String(a.NotEqual)},{label:"Begins with",value:String(a.BeginsWith)},{label:"Ends with",value:String(a.EndsWith)},{label:"Matches",value:String(a.Matches)}],value:String(a.Matches)},seriesNameValue:{label:"Series name",type:l.FilterTypes.TextInput,value:""},releaseYearComparison:{label:"Release year operator",type:l.FilterTypes.Picker,options:[{label:"Equal",value:String(a.Equal)},{label:"Not equal",value:String(a.NotEqual)},{label:"Less than",value:String(a.LessThan)},{label:"Less than or equal",value:String(a.LessThanEqual)},{label:"Greater than",value:String(a.GreaterThan)},{label:"Greater than or equal",value:String(a.GreaterThanEqual)},{label:"Is before",value:String(a.IsBefore)},{label:"Is after",value:String(a.IsAfter)}],value:String(a.Equal)},releaseYearValue:{label:"Release year",type:l.FilterTypes.TextInput,value:""},genres:{label:"Genres",type:l.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}},tags:{label:"Tagy",type:l.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}}},this.imageRequestInit=void 0,this.webStorageUtilized=!0,this.jwtToken=null,this.resolveUrl=function(t,i){return t.startsWith("http")?t:"".concat(e.baseUrl).concat(t.startsWith("/")?"":"/").concat(t)},this.pluginSettings={url:{value:"",label:"Base URL (e.g. https://kavita.example.com)",type:"Text"},apiKey:{value:"",label:"Kavita API Key (from Kavita â†’ API / OPDS)",type:"Text"},formatEpub:{value:!1,label:"EPUB",type:"Switch"},formatPdf:{value:!1,label:"PDF",type:"Switch"},formatImage:{value:!1,label:"Image",type:"Switch"},formatArchive:{value:!1,label:"Archive",type:"Switch"}}}return r.prototype.ensureFilterOptionsLoaded=function(){return t(this,void 0,void 0,(function(){var e,t,a,r,n,s,l,u,c,p,h,d,v,f,m,g,b;return i(this,(function(i){switch(i.label){case 0:return this._filtersLoaded?[2]:"function"!=typeof o.fetchApi?(this._filtersLoaded=!0,[2]):[4,this.ensureToken()];case 1:i.sent(),i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this.apiGet("/api/Filter")];case 3:for(e=i.sent(),this._presetFilterMap.clear(),t=[{label:"None",value:""}],a=0,r=e||[];a<r.length;a++)(n=r[a])&&null!=n.id&&"string"==typeof n.filter&&(s=String(n.id),this._presetFilterMap.set(s,n.filter),t.push({label:n.name||"Filter ".concat(s),value:s}));return this._filters.presetFilter.options=t,[3,5];case 4:return l=i.sent(),console.warn("Kavita: failed to load preset filters",l),[3,5];case 5:return i.trys.push([5,7,,8]),[4,this.apiGet("/api/metadata/tags")];case 6:return u=i.sent(),this._filters.tags.options=u.map((function(e){return{label:e.title,value:String(e.id)}})),[3,8];case 7:return c=i.sent(),console.warn("Kavita: failed to load tags",c),[3,8];case 8:return i.trys.push([8,10,,11]),[4,this.apiGet("/api/metadata/genres")];case 9:return p=i.sent(),this._filters.genres.options=p.map((function(e){return{label:e.title,value:String(e.id)}})),[3,11];case 10:return h=i.sent(),console.warn("Kavita: failed to load genres",h),[3,11];case 11:return i.trys.push([11,13,,14]),[4,this.apiGet("/api/metadata/publication-status")];case 12:return d=i.sent(),this._filters.publicationStatus.options=d.map((function(e){return{label:e.title,value:String(e.value)}})),[3,14];case 13:return v=i.sent(),console.warn("Kavita: failed to load publication statuses",v),[3,14];case 14:return i.trys.push([14,16,,17]),[4,this.apiGet("/api/library/libraries")];case 15:return f=i.sent(),this._filters.libraries.options=f.map((function(e){return{label:e.name,value:String(e.id)}})),[3,17];case 16:return m=i.sent(),console.warn("Kavita: failed to load libraries",m),[3,17];case 17:return i.trys.push([17,19,,20]),[4,this.apiGet("/api/collection?ownedOnly=false")];case 18:return g=i.sent(),this._filters.collectionTags.options=g.map((function(e){return{label:e.title,value:String(e.id)}})),[3,20];case 19:return b=i.sent(),console.warn("Kavita: failed to load collections",b),[3,20];case 20:return this._filtersLoaded=!0,[2]}}))}))},r.prototype.decodePresetFilter=function(a){return t(this,void 0,void 0,(function(){var t,r,l,u,c,p,h,d,v,f,m,g,b;return i(this,(function(i){switch(i.label){case 0:return a?[4,this.ensureToken()]:[2,null];case 1:i.sent(),i.label=2;case 2:return i.trys.push([2,5,,6]),[4,(0,o.fetchApi)("".concat(this.baseUrl,"/api/Filter/decode"),{method:"POST",headers:e({Accept:"application/json","Content-Type":"application/json"},this.getAuthHeaders()),body:JSON.stringify({encodedFilter:a})})];case 3:return[4,i.sent().text()];case 4:return t=i.sent(),[3,6];case 5:return r=i.sent(),console.warn("Kavita: failed to decode preset filter (request)",r),[2,null];case 6:try{return l=JSON.parse(t),u=Number(null==l?void 0:l.combination),c=u===n.MatchAny?n.MatchAny:n.MatchAll,p=Array.isArray(null==l?void 0:l.statements)?l.statements.map((function(e){var t=Number(null==e?void 0:e.field),i=Number(null==e?void 0:e.comparison);return Number.isNaN(t)||Number.isNaN(i)?null:{field:t,comparison:i,value:null===(null==e?void 0:e.value)||void 0===(null==e?void 0:e.value)?void 0:String(e.value)}})).filter(Boolean):[],h=Number(null===(g=null==l?void 0:l.sortOptions)||void 0===g?void 0:g.sortField),d=null===(b=null==l?void 0:l.sortOptions)||void 0===b?void 0:b.isAscending,v="boolean"==typeof d?d:"string"!=typeof d||"true"===d.toLowerCase(),f={sortField:Number.isNaN(h)?s.SortName:h,isAscending:v},m=Number(null==l?void 0:l.limitTo),[2,{id:"number"==typeof(null==l?void 0:l.id)&&Number.isFinite(l.id)?l.id:void 0,name:(null==l?void 0:l.name)||"Preset filter",combination:c,statements:p,sortOptions:f,limitTo:Number.isNaN(m)?0:m}]}catch(e){return console.warn("Kavita: failed to decode preset filter (parse)",e,t),[2,null]}return[2]}}))}))},Object.defineProperty(r.prototype,"filters",{get:function(){return this.ensureFilterOptionsLoaded(),this._filters},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"baseUrl",{get:function(){return this.site},enumerable:!1,configurable:!0}),r.prototype.getBoolSetting=function(e,t){var i=p.storage.get(e);if("boolean"==typeof i)return i;if("string"==typeof i){var a=i.toLowerCase().trim();if(["true","1","yes","on"].includes(a))return!0;if(["false","0","no","off"].includes(a))return!1}return t},r.prototype.ensureToken=function(){return t(this,void 0,void 0,(function(){var e,t,a;return i(this,(function(i){switch(i.label){case 0:if(this.jwtToken)return[2];if("function"!=typeof o.fetchApi)throw new Error("fetchApi is not available in this runtime");return e="".concat(this.baseUrl,"/api/Plugin/authenticate?apiKey=").concat(encodeURIComponent(this.apiKey),"&pluginName=lnreader-kavita"),[4,(0,o.fetchApi)(e,{method:"POST"})];case 1:return[4,i.sent().text()];case 2:t=i.sent();try{a=JSON.parse(t)}catch(e){throw new Error("Authentication failed, non-JSON response: ".concat(t))}if(!(null==a?void 0:a.token))throw new Error("Authentication failed: token missing in response");return console.log("Kavita API: Authenticated successfully - ".concat(a.token)),this.jwtToken=a.token,[2]}}))}))},r.prototype.getAuthHeaders=function(){return this.jwtToken?{Authorization:"Bearer ".concat(this.jwtToken)}:{}},r.prototype.apiGet=function(a){return t(this,void 0,void 0,(function(){var t,r;return i(this,(function(i){switch(i.label){case 0:return[4,this.ensureToken()];case 1:return i.sent(),t=a.startsWith("http")?a:"".concat(this.baseUrl).concat(a.startsWith("/")?"":"/").concat(a),[4,(0,o.fetchApi)(t,{method:"GET",headers:e({Accept:"application/json"},this.getAuthHeaders())})];case 2:return[4,i.sent().text()];case 3:r=i.sent();try{return[2,JSON.parse(r)]}catch(e){return[2,r]}return[2]}}))}))},r.prototype.popularNovels=function(r,u){return t(this,arguments,void 0,(function(t,r){var u,p,d,v,f,m,g,b,y,S,T,N,A,w,P,F,C,k,I,R,L,E,x,_,M,j,O,B,G,q,K,U,W,Y,J,D,H,z,V,Q,X,Z,$=this,ee=r.showLatestNovels,te=r.filters;return i(this,(function(i){switch(i.label){case 0:return[4,this.ensureToken()];case 1:return i.sent(),[4,this.ensureFilterOptionsLoaded()];case 2:return i.sent(),u=30,p=null==te?void 0:te.presetFilter,d=p&&p.type===l.FilterTypes.Picker&&"string"==typeof p.value?p.value.trim():"",v=null,d?(f=this._presetFilterMap.get(d))?[4,this.decodePresetFilter(f)]:[3,4]:[3,5];case 3:return v=i.sent(),[3,5];case 4:console.warn("Kavita: preset filter ".concat(d," missing from cache")),i.label=5;case 5:return m=Boolean(d),g=m,v?(g=!0,b=v):m?b=new h("LNReader: Preset (fallback)").combination(n.MatchAll).sortBy(s.SortName,!0).limitTo(0).build():(y=function(e,t,i){var a=null==te?void 0:te[e];if(!a||a.type!==l.FilterTypes.ExcludableCheckboxGroup||"object"!=typeof a)return!1;var r=a.value||{},n=!1,s=Array.isArray(r.include)?r.include:[];s.length>0&&(t(s),n=!0);var o=Array.isArray(r.exclude)?r.exclude:[];return o.length>0&&(i(o),n=!0),n},S=n.MatchAll,(T=null==te?void 0:te.filterCombination)&&T.type===l.FilterTypes.Picker&&"string"==typeof T.value&&((O=Number(T.value))!==n.MatchAny&&O!==n.MatchAll||(S=O)),g=!1,N=0,(A=null==te?void 0:te.limitTo)&&A.type===l.FilterTypes.TextInput&&(w=String(null!==(Q=A.value)&&void 0!==Q?Q:"").trim())&&(O=Number(w),Number.isFinite(O)&&O>=0&&(N=O,O>0&&(g=!0))),P=s.SortName,F=!0,(C=null==te?void 0:te.sortField)&&C.type===l.FilterTypes.Picker&&"string"==typeof C.value&&(O=Number(C.value),Number.isNaN(O)||(P=O)),(k=null==te?void 0:te.sortDirection)&&k.type===l.FilterTypes.Picker&&"string"==typeof k.value&&(F="true"===k.value.toLowerCase()),P===s.SortName&&!0===F||(g=!0),I=new h("LNReader: Recently Added").combination(S).sortBy(P,F).limitTo(N),y("genres",(function(e){return I.whereGenresInclude(e)}),(function(e){return I.whereGenresExclude(e)}))&&(g=!0),y("publicationStatus",(function(e){return I.wherePublicationStatusInclude(e)}),(function(e){return I.wherePublicationStatusExclude(e)}))&&(g=!0),y("libraries",(function(e){return I.whereLibrariesInclude(e)}),(function(e){return I.whereLibrariesExclude(e)}))&&(g=!0),R=null==te?void 0:te.releaseYearValue,L=null==te?void 0:te.releaseYearComparison,R&&R.type===l.FilterTypes.TextInput&&(E=(null!==(X=R.value)&&void 0!==X?X:"").trim())&&(j=a.Equal,L&&L.type===l.FilterTypes.Picker&&"string"==typeof L.value&&(O=Number(L.value),Number.isNaN(O)||(j=O)),I.whereReleaseYear(j,E),g=!0),x=null==te?void 0:te.seriesNameValue,_=null==te?void 0:te.seriesNameComparison,x&&x.type===l.FilterTypes.TextInput&&(M=(null!==(Z=x.value)&&void 0!==Z?Z:"").trim())&&(j=a.Matches,_&&_.type===l.FilterTypes.Picker&&"string"==typeof _.value&&(O=Number(_.value),Number.isNaN(O)||(j=O)),I.whereSeriesName(j,M),g=!0),y("tags",(function(e){return I.whereTagsInclude(e)}),(function(e){return I.whereTagsExclude(e)}))&&(g=!0),y("collectionTags",(function(e){return I.whereCollectionTagsInclude(e)}),(function(e){return I.whereCollectionTagsExclude(e)}))&&(g=!0),(B=null==te?void 0:te.wantToRead)&&B.type===l.FilterTypes.Picker&&"string"==typeof B.value&&("true"!==(G=B.value.trim().toLowerCase())&&"false"!==G||(I.whereWantToRead(G),g=!0)),q=this.getBoolSetting("formatImage",!1),K=this.getBoolSetting("formatArchive",!1),U=this.getBoolSetting("formatEpub",!1),W=this.getBoolSetting("formatPdf",!1),Y=[],q&&Y.push("0"),K&&Y.push("1"),U&&Y.push("3"),W&&Y.push("4"),Y.length>0&&I.whereFormatsContains(Y),b=I.build()),console.log("Kavita API: popularNovels",{pageNo:t,showLatestNovels:ee,hasUserFilters:g,usingPresetFilter:Boolean(v),presetFilterSelected:m}),J=ee&&!g?"/api/Series/recently-added-v2":"/api/Series/v2",D="".concat(this.baseUrl).concat(J,"?PageNumber=").concat(t,"&PageSize=").concat(u),[4,(0,o.fetchApi)(D,{method:"POST",headers:e({Accept:"text/plain","Content-Type":"application/json"},this.getAuthHeaders()),body:JSON.stringify(b)})];case 6:return[4,i.sent().text()];case 7:H=i.sent(),z=[];try{z=JSON.parse(H)}catch(e){return console.warn("Kavita API: popularNovels - invalid JSON response"),[2,[]]}return V=(z||[]).map((function(e){var t,i,a,r=null!==(t=e.id)&&void 0!==t?t:e.seriesId,n=null!==(a=null!==(i=e.name)&&void 0!==i?i:e.seriesName)&&void 0!==a?a:"Unknown series",s=r?"".concat($.baseUrl,"/api/image/series-cover?seriesId=").concat(r).concat($.apiKey?"&apiKey=".concat($.apiKey):""):c.defaultCover;return{name:n,path:String(r),cover:s}})),[2,V]}}))}))},r.prototype.flattenBookChapters=function(e){var t=[],i=function(e){var a;"number"==typeof e.page&&t.push({page:e.page,title:null!==(a=e.title)&&void 0!==a?a:""}),Array.isArray(e.children)&&e.children.forEach(i)};return Array.isArray(e)&&e.forEach(i),t.sort((function(e,t){return e.page-t.page})),t},r.prototype.getTitleForPage=function(e,t){for(var i=null,a=0,r=e;a<r.length;a++){var n=r[a];if(!(n.page<=t))break;i=n.title||null}return i},r.prototype.parseNovel=function(a){return t(this,void 0,void 0,(function(){var t,r,n,s,l,c,p,h,d,v,f,m,g,b,y,S,T,N,A,w,P,F,C,k,I,R,L,E,x,_,M,j,O,B,G,q,K,U,W,Y,J,D,H,z,V,Q,X,Z,$,ee,te,ie,ae,re,ne,se,oe,le,ue,ce,pe,he,de,ve,fe,me,ge;return i(this,(function(i){switch(i.label){case 0:return[4,this.ensureToken()];case 1:return i.sent(),t=e({Accept:"application/json"},this.getAuthHeaders()),r=Number(a.startsWith("/api/Series/")?a.split("/").pop():a),[4,Promise.all([(0,o.fetchApi)("".concat(this.site,"/api/Series/").concat(r),{headers:t}),(0,o.fetchApi)("".concat(this.site,"/api/Series/metadata?seriesId=").concat(r),{headers:t}),(0,o.fetchApi)("".concat(this.site,"/api/Series/volumes?seriesId=").concat(r),{headers:t})])];case 2:return n=i.sent(),s=n[0],l=n[1],c=n[2],[4,s.json()];case 3:return p=i.sent(),[4,l.json()];case 4:return h=i.sent(),[4,c.json()];case 5:switch(d=i.sent(),v={path:String(r),name:null!==(Q=null!==(V=p.name)&&void 0!==V?V:h.title)&&void 0!==Q?Q:"Untitled",cover:"".concat(this.site,"/api/image/series-cover?seriesId=").concat(r).concat(this.apiKey?"&apiKey=".concat(this.apiKey):""),chapters:[]},Array.isArray(h.people)&&h.people.length?(f=h.people.filter((function(e){return String(e.role||"").toLowerCase().includes("writer")}))).length&&(v.author=f.map((function(e){return e.name})).join(", ")):(m=Array.isArray(d)?d[0]:null,(g=m&&Array.isArray(m.chapters)?m.chapters[0]:null)&&Array.isArray(g.writers)&&(v.author=g.writers.map((function(e){return e.name})).join(", "))),h.publicationStatus){case 0:v.status=u.NovelStatus.Ongoing;break;case 1:v.status=u.NovelStatus.OnHiatus;break;case 2:v.status=u.NovelStatus.Completed;break;case 3:v.status=u.NovelStatus.Cancelled;break;default:v.status=u.NovelStatus.Unknown}if(Array.isArray(h.genres)&&h.genres.length)v.genres=h.genres.map((function(e){var t,i,a;return null!==(a=null!==(i=null!==(t=e.title)&&void 0!==t?t:e.name)&&void 0!==i?i:e.label)&&void 0!==a?a:e.value})).filter(Boolean).join(", ");else{for(b=new Set,y=0,S=d;y<S.length;y++)for(x=S[y],T=0,N=null!==(X=x.chapters)&&void 0!==X?X:[];T<N.length;T++)for(O=N[T],A=0,w=null!==(Z=O.genres)&&void 0!==Z?Z:[];A<w.length;A++)P=w[A],(F=null!==($=P.title)&&void 0!==$?$:P.name)&&b.add(F);b.size&&(v.genres=Array.from(b).join(", "))}v.summary=null!==(ae=null!==(ie=null!==(te=null!==(ee=h.summary)&&void 0!==ee?ee:h.description)&&void 0!==te?te:p.summary)&&void 0!==ie?ie:p.description)&&void 0!==ae?ae:void 0,"number"==typeof(C=null!==(se=null!==(ne=null!==(re=h.userRating)&&void 0!==re?re:h.averageRating)&&void 0!==ne?ne:p.userRating)&&void 0!==se?se:p.averageRating)&&(v.rating=C),(k=null!==(ue=null!==(le=null!==(oe=h.seriesStatus)&&void 0!==oe?oe:h.status)&&void 0!==le?le:p.status)&&void 0!==ue?ue:p.seriesStatus)&&(v.status=String(k)),I=[],R=1,L=0,E=d,i.label=6;case 6:if(!(L<E.length))return[3,11];if(x=E[L],!(_=null!==(ce=x.chapters)&&void 0!==ce?ce:[]).length)return[3,10];M=0,j=_,i.label=7;case 7:return M<j.length?(O=j[M],(B=O.id)?[4,Promise.all([(0,o.fetchApi)("".concat(this.site,"/api/Book/").concat(B,"/book-info"),{headers:t}).then((function(e){return e.json()})),(0,o.fetchApi)("".concat(this.site,"/api/Book/").concat(B,"/chapters"),{headers:t}).then((function(e){return e.json()}))])]:[3,9]):[3,10];case 8:if(G=i.sent(),q=G[0],K=G[1],!(U=null!==(de=null!==(he=null!==(pe=q.pages)&&void 0!==pe?pe:O.pages)&&void 0!==he?he:x.pages)&&void 0!==de?de:0))return[3,9];for(W=this.flattenBookChapters(K),Y=null!==(ve=q.volumeNumber)&&void 0!==ve?ve:x.number,J=q.bookTitle||O.titleName||(null!=Y?"".concat(p.name,", Vol. ").concat(Y):p.name),D=0;D<U;D++)H=this.getTitleForPage(W,D),(z=[]).push("".concat(D+1," / ").concat(U)),H&&z.push(H),J&&z.push(J),I.push({name:z.join(" - "),path:"".concat(B,":").concat(D),chapterNumber:R++,releaseTime:null!==(ge=null!==(me=null!==(fe=O.releaseDate)&&void 0!==fe?fe:O.created)&&void 0!==me?me:O.createdUtc)&&void 0!==ge?ge:null});i.label=9;case 9:return M++,[3,7];case 10:return L++,[3,6];case 11:return v.chapters=I,[2,v]}}))}))},r.prototype.parseChapter=function(a){return t(this,void 0,void 0,(function(){var t,r,n,s,l,u;return i(this,(function(i){switch(i.label){case 0:return[4,this.ensureToken()];case 1:if(i.sent(),t=e({Accept:"text/plain,application/json"},this.getAuthHeaders()),r=a.split(":"),n=r[0],s=r[1],l=Number(n),u=Number(s||"0"),!l||Number.isNaN(l))throw new Error("Invalid chapterPath: ".concat(a));return[4,(0,o.fetchApi)("".concat(this.site,"/api/Book/").concat(l,"/book-page?page=").concat(u),{headers:t})];case 2:return[4,i.sent().text()];case 3:return[2,i.sent()]}}))}))},r.prototype.searchNovels=function(r,l){return t(this,void 0,void 0,(function(){var t,u,p,d,v,f,m,g,b,y,S,T,N,A,w=this;return i(this,(function(i){switch(i.label){case 0:return(t=r.trim())?[4,this.ensureToken()]:[2,[]];case 1:return i.sent(),u=Math.max(l||1,1),p=new h("LNReader: Search").combination(n.MatchAll).sortBy(s.SortName,!0).limitTo(0).whereSeriesName(a.Matches,t),d=this.getBoolSetting("formatImage",!1),v=this.getBoolSetting("formatArchive",!1),f=this.getBoolSetting("formatEpub",!0),m=this.getBoolSetting("formatPdf",!0),g=[],d&&g.push("0"),v&&g.push("1"),f&&g.push("3"),m&&g.push("4"),g.length>0&&p.whereFormatsContains(g),b=p.build(),y="".concat(this.baseUrl,"/api/Series/v2?PageNumber=").concat(u,"&PageSize=").concat(12),[4,(0,o.fetchApi)(y,{method:"POST",headers:e({Accept:"text/plain","Content-Type":"application/json"},this.getAuthHeaders()),body:JSON.stringify(b)})];case 2:return[4,i.sent().text()];case 3:S=i.sent(),T=[];try{T=JSON.parse(S)}catch(e){return console.warn("Kavita API: searchNovels - invalid JSON response"),[2,[]]}return N=Array.isArray(T)?T:(null==T?void 0:T.series)||(null==T?void 0:T.seriesResults)||(null==T?void 0:T.seriesDtos)||[],A=N.filter(Boolean).map((function(e){var t,i,a,r=null!==(t=null==e?void 0:e.seriesId)&&void 0!==t?t:null==e?void 0:e.id,n=null!==(a=null!==(i=null==e?void 0:e.name)&&void 0!==i?i:null==e?void 0:e.seriesName)&&void 0!==a?a:"Unknown series",s=r?"".concat(w.baseUrl,"/api/image/series-cover?seriesId=").concat(r).concat(w.apiKey?"&apiKey=".concat(w.apiKey):""):c.defaultCover;return{name:n,path:String(r),cover:s}})),[2,A]}}))}))},r}();exports.default=new d;