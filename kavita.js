var e=this&&this.__assign||function(){return e=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},e.apply(this,arguments)},t=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,i){function s(e){try{l(r.next(e))}catch(e){i(e)}}function o(e){try{l(r.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,o)}l((r=r.apply(e,t||[])).next())}))},n=this&&this.__generator||function(e,t){var n,r,a,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=o(0),s.throw=o(1),s.return=o(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function o(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s&&(s=0,o[0]&&(i=0)),i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}};Object.defineProperty(exports,"__esModule",{value:!0});var r,a,i,s=require("@libs/fetch"),o=require("@libs/filterInputs"),l=require("@libs/novelStatus"),u=require("@libs/defaultCover"),c=require("@libs/storage");!function(e){e[e.Equal=0]="Equal",e[e.GreaterThan=1]="GreaterThan",e[e.GreaterThanEqual=2]="GreaterThanEqual",e[e.LessThan=3]="LessThan",e[e.LessThanEqual=4]="LessThanEqual",e[e.Contains=5]="Contains",e[e.MustContains=6]="MustContains",e[e.Matches=7]="Matches",e[e.NotContains=8]="NotContains",e[e.NotEqual=9]="NotEqual",e[e.BeginsWith=10]="BeginsWith",e[e.EndsWith=11]="EndsWith",e[e.IsBefore=12]="IsBefore",e[e.IsAfter=13]="IsAfter",e[e.IsInLast=14]="IsInLast",e[e.IsNotInLast=15]="IsNotInLast",e[e.IsEmpty=16]="IsEmpty"}(r||(r={})),function(e){e[e.Summary=0]="Summary",e[e.SeriesName=1]="SeriesName",e[e.PublicationStatus=2]="PublicationStatus",e[e.Languages=3]="Languages",e[e.AgeRating=4]="AgeRating",e[e.UserRating=5]="UserRating",e[e.Tags=6]="Tags",e[e.CollectionTags=7]="CollectionTags",e[e.Translators=8]="Translators",e[e.Characters=9]="Characters",e[e.Publisher=10]="Publisher",e[e.Editor=11]="Editor",e[e.Artist=12]="Artist",e[e.Letterer=13]="Letterer",e[e.Colorist=14]="Colorist",e[e.Inker=15]="Inker",e[e.Penciller=16]="Penciller",e[e.Writers=17]="Writers",e[e.Genres=18]="Genres",e[e.Libraries=19]="Libraries",e[e.ReadingProgress=20]="ReadingProgress",e[e.Formats=21]="Formats",e[e.ReleaseYear=22]="ReleaseYear",e[e.ReadTime=23]="ReadTime",e[e.Path=24]="Path",e[e.FilePath=25]="FilePath",e[e.WantToRead=26]="WantToRead",e[e.ReadDate=27]="ReadDate",e[e.AverageRating=28]="AverageRating",e[e.Imprint=29]="Imprint",e[e.Team=30]="Team",e[e.Location=31]="Location",e[e.LastRead=32]="LastRead",e[e.FileSize=33]="FileSize"}(a||(a={})),function(e){e[e.MatchAny=0]="MatchAny",e[e.MatchAll=1]="MatchAll"}(i||(i={}));var h=function(){function e(e){this._combination=i.MatchAll,this._statements=[],this._sortField=a.SeriesName,this._sortAscending=!0,this._limitTo=0,this._name=e}return e.prototype.combination=function(e){return this._combination=e,this},e.prototype.sortBy=function(e,t){return void 0===t&&(t=!0),this._sortField=e,this._sortAscending=t,this},e.prototype.limitTo=function(e){return this._limitTo=e,this},e.prototype.whereGenresInclude=function(e){return e&&0!==e.length?(this._statements.push({field:a.Genres,comparison:r.MustContains,value:e.join(",")}),this):this},e.prototype.whereGenresExclude=function(e){return e&&0!==e.length?(this._statements.push({field:a.Genres,comparison:r.NotContains,value:e.join(",")}),this):this},e.prototype.wherePublicationStatusInclude=function(e){return e&&0!==e.length?(this._statements.push({field:a.PublicationStatus,comparison:r.Contains,value:e.join(",")}),this):this},e.prototype.wherePublicationStatusExclude=function(e){return e&&0!==e.length?(this._statements.push({field:a.PublicationStatus,comparison:r.NotContains,value:e.join(",")}),this):this},e.prototype.whereLibrariesInclude=function(e){return e&&0!==e.length?(this._statements.push({field:a.Libraries,comparison:r.Contains,value:e.join(",")}),this):this},e.prototype.whereLibrariesExclude=function(e){return e&&0!==e.length?(this._statements.push({field:a.Libraries,comparison:r.NotContains,value:e.join(",")}),this):this},e.prototype.whereFormatsContains=function(e){return e&&0!==e.length?(this._statements.push({field:a.Formats,comparison:r.Contains,value:e.join(",")}),this):this},e.prototype.whereReleaseYear=function(e,t){var n=null!=t?String(t).trim():"";return n?(this._statements.push({field:a.ReleaseYear,comparison:e,value:n}),this):this},e.prototype.whereSeriesName=function(e,t){var n=(null!=t?t:"").trim();return n?(this._statements.push({field:a.SeriesName,comparison:e,value:n}),this):this},e.prototype.whereTagsInclude=function(e){return e&&0!==e.length?(this._statements.push({field:a.Tags,comparison:r.MustContains,value:e.join(",")}),this):this},e.prototype.whereTagsExclude=function(e){return e&&0!==e.length?(this._statements.push({field:a.Tags,comparison:r.NotContains,value:e.join(",")}),this):this},e.prototype.build=function(){return{name:this._name,combination:this._combination,statements:this._statements,sortOptions:{sortField:this._sortField,isAscending:this._sortAscending},limitTo:this._limitTo}},e}(),p=function(){function p(){var e=this;this.id="kavita-api",this.name="Kavita",this.icon="src/multi/kavita/icon.png",this.version="0.0.2",this.site=c.storage.get("url"),this.apiKey=c.storage.get("apiKey"),this._filtersLoaded=!1,this._filters={filterCombination:{label:"Filter combination",type:o.FilterTypes.Picker,options:[{label:"Match any (OR)",value:String(i.MatchAny)},{label:"Match all (AND)",value:String(i.MatchAll)}],value:String(i.MatchAll)},genres:{label:"Genres",type:o.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}},publicationStatus:{label:"Publication status",type:o.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}},libraries:{label:"Libraries",type:o.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}},releaseYearComparison:{label:"Release year operator",type:o.FilterTypes.Picker,options:[{label:"Equal",value:String(r.Equal)},{label:"Not equal",value:String(r.NotEqual)},{label:"Less than",value:String(r.LessThan)},{label:"Less than or equal",value:String(r.LessThanEqual)},{label:"Greater than",value:String(r.GreaterThan)},{label:"Greater than or equal",value:String(r.GreaterThanEqual)},{label:"Is before",value:String(r.IsBefore)},{label:"Is after",value:String(r.IsAfter)}],value:String(r.Equal)},releaseYearValue:{label:"Release year",type:o.FilterTypes.TextInput,value:""},seriesNameComparison:{label:"Series name operator",type:o.FilterTypes.Picker,options:[{label:"Equal",value:String(r.Equal)},{label:"Not equal",value:String(r.NotEqual)},{label:"Begins with",value:String(r.BeginsWith)},{label:"Ends with",value:String(r.EndsWith)},{label:"Matches",value:String(r.Matches)}],value:String(r.Matches)},seriesNameValue:{label:"Series name",type:o.FilterTypes.TextInput,value:""},tags:{label:"Tagy",type:o.FilterTypes.ExcludableCheckboxGroup,options:[],value:{include:[],exclude:[]}}},this.imageRequestInit=void 0,this.webStorageUtilized=!0,this.jwtToken=null,this.resolveUrl=function(t,n){return t.startsWith("http")?t:"".concat(e.baseUrl).concat(t.startsWith("/")?"":"/").concat(t)},this.pluginSettings={url:{value:"",label:"Base URL (e.g. https://kavita.example.com)",type:"Text"},apiKey:{value:"",label:"Kavita API Key (from Kavita â†’ API / OPDS)",type:"Text"},formatEpub:{value:!1,label:"EPUB",type:"Switch"},formatPdf:{value:!1,label:"PDF",type:"Switch"},formatImage:{value:!1,label:"Image",type:"Switch"},formatArchive:{value:!1,label:"Archive",type:"Switch"}}}return p.prototype.ensureFilterOptionsLoaded=function(){return t(this,void 0,void 0,(function(){var e,t,r,a,i,o,l,u;return n(this,(function(n){switch(n.label){case 0:return this._filtersLoaded?[2]:"function"!=typeof s.fetchApi?(this._filtersLoaded=!0,[2]):[4,this.ensureToken()];case 1:n.sent(),n.label=2;case 2:return n.trys.push([2,4,,5]),[4,this.apiGet("/api/metadata/tags")];case 3:return e=n.sent(),this._filters.tags.options=e.map((function(e){return{label:e.title,value:String(e.id)}})),[3,5];case 4:return t=n.sent(),console.warn("Kavita: failed to load tags",t),[3,5];case 5:return n.trys.push([5,7,,8]),[4,this.apiGet("/api/metadata/genres")];case 6:return r=n.sent(),this._filters.genres.options=r.map((function(e){return{label:e.title,value:String(e.id)}})),[3,8];case 7:return a=n.sent(),console.warn("Kavita: failed to load genres",a),[3,8];case 8:return n.trys.push([8,10,,11]),[4,this.apiGet("/api/metadata/publication-status")];case 9:return i=n.sent(),this._filters.publicationStatus.options=i.map((function(e){return{label:e.title,value:String(e.value)}})),[3,11];case 10:return o=n.sent(),console.warn("Kavita: failed to load publication statuses",o),[3,11];case 11:return n.trys.push([11,13,,14]),[4,this.apiGet("/api/library/libraries")];case 12:return l=n.sent(),this._filters.libraries.options=l.map((function(e){return{label:e.name,value:String(e.id)}})),[3,14];case 13:return u=n.sent(),console.warn("Kavita: failed to load libraries",u),[3,14];case 14:return this._filtersLoaded=!0,[2]}}))}))},Object.defineProperty(p.prototype,"filters",{get:function(){return this.ensureFilterOptionsLoaded(),this._filters},enumerable:!1,configurable:!0}),Object.defineProperty(p.prototype,"baseUrl",{get:function(){return this.site},enumerable:!1,configurable:!0}),p.prototype.getBoolSetting=function(e,t){var n=c.storage.get(e);if("boolean"==typeof n)return n;if("string"==typeof n){var r=n.toLowerCase().trim();if(["true","1","yes","on"].includes(r))return!0;if(["false","0","no","off"].includes(r))return!1}return t},p.prototype.ensureToken=function(){return t(this,void 0,void 0,(function(){var e,t,r;return n(this,(function(n){switch(n.label){case 0:if(this.jwtToken)return[2];if("function"!=typeof s.fetchApi)throw new Error("fetchApi is not available in this runtime");return e="".concat(this.baseUrl,"/api/Plugin/authenticate?apiKey=").concat(encodeURIComponent(this.apiKey),"&pluginName=lnreader-kavita"),[4,(0,s.fetchApi)(e,{method:"POST"})];case 1:return[4,n.sent().text()];case 2:t=n.sent();try{r=JSON.parse(t)}catch(e){throw new Error("Authentication failed, non-JSON response: ".concat(t))}if(!(null==r?void 0:r.token))throw new Error("Authentication failed: token missing in response");return console.log("Kavita API: Authenticated successfully - ".concat(r.token)),this.jwtToken=r.token,[2]}}))}))},p.prototype.getAuthHeaders=function(){return this.jwtToken?{Authorization:"Bearer ".concat(this.jwtToken)}:{}},p.prototype.apiGet=function(r){return t(this,void 0,void 0,(function(){var t,a;return n(this,(function(n){switch(n.label){case 0:return[4,this.ensureToken()];case 1:return n.sent(),t=r.startsWith("http")?r:"".concat(this.baseUrl).concat(r.startsWith("/")?"":"/").concat(r),[4,(0,s.fetchApi)(t,{method:"GET",headers:e({Accept:"application/json"},this.getAuthHeaders())})];case 2:return[4,n.sent().text()];case 3:a=n.sent();try{return[2,JSON.parse(a)]}catch(e){return[2,a]}return[2]}}))}))},p.prototype.popularNovels=function(l,c){return t(this,arguments,void 0,(function(t,l){var c,p,d,f,v,g,m,b,y,S,A,w,T,N,I,k,E,P,C,x,_,L,j,F,R,G,q=this,K=l.showLatestNovels,O=l.filters;return n(this,(function(n){switch(n.label){case 0:return[4,this.ensureToken()];case 1:return n.sent(),[4,this.ensureFilterOptionsLoaded()];case 2:return n.sent(),c=function(e,t,n){var r=null==O?void 0:O[e];if(!r||r.type!==o.FilterTypes.ExcludableCheckboxGroup||"object"!=typeof r)return!1;var a=r.value||{},i=!1,s=Array.isArray(a.include)?a.include:[];s.length>0&&(t(s),i=!0);var l=Array.isArray(a.exclude)?a.exclude:[];return l.length>0&&(n(l),i=!0),i},p=i.MatchAll,(d=null==O?void 0:O.filterCombination)&&d.type===o.FilterTypes.Picker&&"string"==typeof d.value&&((T=Number(d.value))!==i.MatchAny&&T!==i.MatchAll||(p=T)),f=!1,v=new h("LNReader: Recently Added").combination(p).sortBy(a.SeriesName,!0).limitTo(0),c("genres",(function(e){return v.whereGenresInclude(e)}),(function(e){return v.whereGenresExclude(e)}))&&(f=!0),c("publicationStatus",(function(e){return v.wherePublicationStatusInclude(e)}),(function(e){return v.wherePublicationStatusExclude(e)}))&&(f=!0),c("libraries",(function(e){return v.whereLibrariesInclude(e)}),(function(e){return v.whereLibrariesExclude(e)}))&&(f=!0),g=null==O?void 0:O.releaseYearValue,m=null==O?void 0:O.releaseYearComparison,g&&g.type===o.FilterTypes.TextInput&&(b=(null!==(R=g.value)&&void 0!==R?R:"").trim())&&(w=r.Equal,m&&m.type===o.FilterTypes.Picker&&"string"==typeof m.value&&(T=Number(m.value),Number.isNaN(T)||(w=T)),v.whereReleaseYear(w,b),f=!0),y=null==O?void 0:O.seriesNameValue,S=null==O?void 0:O.seriesNameComparison,y&&y.type===o.FilterTypes.TextInput&&(A=(null!==(G=y.value)&&void 0!==G?G:"").trim())&&(w=r.Matches,S&&S.type===o.FilterTypes.Picker&&"string"==typeof S.value&&(T=Number(S.value),Number.isNaN(T)||(w=T)),v.whereSeriesName(w,A),f=!0),c("tags",(function(e){return v.whereTagsInclude(e)}),(function(e){return v.whereTagsExclude(e)}))&&(f=!0),N=this.getBoolSetting("formatImage",!1),I=this.getBoolSetting("formatArchive",!1),k=this.getBoolSetting("formatEpub",!1),E=this.getBoolSetting("formatPdf",!1),P=[],N&&P.push("0"),I&&P.push("1"),k&&P.push("3"),E&&P.push("4"),P.length>0&&v.whereFormatsContains(P),C=v.build(),console.log("Kavita API: popularNovels",{pageNo:t,showLatestNovels:K,hasUserFilters:f}),x=K&&!f?"/api/Series/recently-added-v2":"/api/Series/v2",_="".concat(this.baseUrl).concat(x,"?PageNumber=").concat(t,"&PageSize=").concat(30),[4,(0,s.fetchApi)(_,{method:"POST",headers:e({Accept:"text/plain","Content-Type":"application/json"},this.getAuthHeaders()),body:JSON.stringify(C)})];case 3:return[4,n.sent().text()];case 4:L=n.sent(),j=[];try{j=JSON.parse(L)}catch(e){return console.warn("Kavita API: popularNovels - invalid JSON response"),[2,[]]}return F=(j||[]).map((function(e){var t,n,r,a=null!==(t=e.id)&&void 0!==t?t:e.seriesId,i=null!==(r=null!==(n=e.name)&&void 0!==n?n:e.seriesName)&&void 0!==r?r:"Unknown series",s=a?"".concat(q.baseUrl,"/api/image/series-cover?seriesId=").concat(a).concat(q.apiKey?"&apiKey=".concat(q.apiKey):""):u.defaultCover;return{name:i,path:String(a),cover:s}})),[2,F]}}))}))},p.prototype.flattenBookChapters=function(e){var t=[],n=function(e){var r;"number"==typeof e.page&&t.push({page:e.page,title:null!==(r=e.title)&&void 0!==r?r:""}),Array.isArray(e.children)&&e.children.forEach(n)};return Array.isArray(e)&&e.forEach(n),t.sort((function(e,t){return e.page-t.page})),t},p.prototype.getTitleForPage=function(e,t){for(var n=null,r=0,a=e;r<a.length;r++){var i=a[r];if(!(i.page<=t))break;n=i.title||null}return n},p.prototype.parseNovel=function(r){return t(this,void 0,void 0,(function(){var t,a,i,o,u,c,h,p,d,f,v,g,m,b,y,S,A,w,T,N,I,k,E,P,C,x,_,L,j,F,R,G,q,K,O,M,B,U,W,Y,D,H,J,z,V,Q,X,Z,$,ee,te,ne,re,ae,ie,se,oe,le,ue,ce,he,pe,de,fe,ve,ge,me;return n(this,(function(n){switch(n.label){case 0:return[4,this.ensureToken()];case 1:return n.sent(),t=e({Accept:"application/json"},this.getAuthHeaders()),a=Number(r.startsWith("/api/Series/")?r.split("/").pop():r),[4,Promise.all([(0,s.fetchApi)("".concat(this.site,"/api/Series/").concat(a),{headers:t}),(0,s.fetchApi)("".concat(this.site,"/api/Series/metadata?seriesId=").concat(a),{headers:t}),(0,s.fetchApi)("".concat(this.site,"/api/Series/volumes?seriesId=").concat(a),{headers:t})])];case 2:return i=n.sent(),o=i[0],u=i[1],c=i[2],[4,o.json()];case 3:return h=n.sent(),[4,u.json()];case 4:return p=n.sent(),[4,c.json()];case 5:switch(d=n.sent(),f={path:String(a),name:null!==(Q=null!==(V=h.name)&&void 0!==V?V:p.title)&&void 0!==Q?Q:"Untitled",cover:"".concat(this.site,"/api/image/series-cover?seriesId=").concat(a).concat(this.apiKey?"&apiKey=".concat(this.apiKey):""),chapters:[]},Array.isArray(p.people)&&p.people.length?(v=p.people.filter((function(e){return String(e.role||"").toLowerCase().includes("writer")}))).length&&(f.author=v.map((function(e){return e.name})).join(", ")):(g=Array.isArray(d)?d[0]:null,(m=g&&Array.isArray(g.chapters)?g.chapters[0]:null)&&Array.isArray(m.writers)&&(f.author=m.writers.map((function(e){return e.name})).join(", "))),p.publicationStatus){case 0:f.status=l.NovelStatus.Ongoing;break;case 1:f.status=l.NovelStatus.OnHiatus;break;case 2:f.status=l.NovelStatus.Completed;break;case 3:f.status=l.NovelStatus.Cancelled;break;default:f.status=l.NovelStatus.Unknown}if(Array.isArray(p.genres)&&p.genres.length)f.genres=p.genres.map((function(e){var t,n,r;return null!==(r=null!==(n=null!==(t=e.title)&&void 0!==t?t:e.name)&&void 0!==n?n:e.label)&&void 0!==r?r:e.value})).filter(Boolean).join(", ");else{for(b=new Set,y=0,S=d;y<S.length;y++)for(j=S[y],A=0,w=null!==(X=j.chapters)&&void 0!==X?X:[];A<w.length;A++)for(q=w[A],T=0,N=null!==(Z=q.genres)&&void 0!==Z?Z:[];T<N.length;T++)I=N[T],(k=null!==($=I.title)&&void 0!==$?$:I.name)&&b.add(k);b.size&&(f.genres=Array.from(b).join(", "))}f.summary=null!==(re=null!==(ne=null!==(te=null!==(ee=p.summary)&&void 0!==ee?ee:p.description)&&void 0!==te?te:h.summary)&&void 0!==ne?ne:h.description)&&void 0!==re?re:void 0,"number"==typeof(E=null!==(se=null!==(ie=null!==(ae=p.userRating)&&void 0!==ae?ae:p.averageRating)&&void 0!==ie?ie:h.userRating)&&void 0!==se?se:h.averageRating)&&(f.rating=E),(P=null!==(ue=null!==(le=null!==(oe=p.seriesStatus)&&void 0!==oe?oe:p.status)&&void 0!==le?le:h.status)&&void 0!==ue?ue:h.seriesStatus)&&(f.status=String(P)),C=[],x=1,_=0,L=d,n.label=6;case 6:if(!(_<L.length))return[3,11];if(j=L[_],!(F=null!==(ce=j.chapters)&&void 0!==ce?ce:[]).length)return[3,10];R=0,G=F,n.label=7;case 7:return R<G.length?(q=G[R],(K=q.id)?[4,Promise.all([(0,s.fetchApi)("".concat(this.site,"/api/Book/").concat(K,"/book-info"),{headers:t}).then((function(e){return e.json()})),(0,s.fetchApi)("".concat(this.site,"/api/Book/").concat(K,"/chapters"),{headers:t}).then((function(e){return e.json()}))])]:[3,9]):[3,10];case 8:if(O=n.sent(),M=O[0],B=O[1],!(U=null!==(de=null!==(pe=null!==(he=M.pages)&&void 0!==he?he:q.pages)&&void 0!==pe?pe:j.pages)&&void 0!==de?de:0))return[3,9];for(W=this.flattenBookChapters(B),Y=null!==(fe=M.volumeNumber)&&void 0!==fe?fe:j.number,D=M.bookTitle||q.titleName||(null!=Y?"".concat(h.name,", Vol. ").concat(Y):h.name),H=0;H<U;H++)J=this.getTitleForPage(W,H),(z=[]).push("".concat(H+1," / ").concat(U)),J&&z.push(J),D&&z.push(D),C.push({name:z.join(" - "),path:"".concat(K,":").concat(H),chapterNumber:x++,releaseTime:null!==(me=null!==(ge=null!==(ve=q.releaseDate)&&void 0!==ve?ve:q.created)&&void 0!==ge?ge:q.createdUtc)&&void 0!==me?me:null});n.label=9;case 9:return R++,[3,7];case 10:return _++,[3,6];case 11:return f.chapters=C,[2,f]}}))}))},p.prototype.parseChapter=function(r){return t(this,void 0,void 0,(function(){var t,a,i,o,l,u;return n(this,(function(n){switch(n.label){case 0:return[4,this.ensureToken()];case 1:if(n.sent(),t=e({Accept:"text/plain,application/json"},this.getAuthHeaders()),a=r.split(":"),i=a[0],o=a[1],l=Number(i),u=Number(o||"0"),!l||Number.isNaN(l))throw new Error("Invalid chapterPath: ".concat(r));return[4,(0,s.fetchApi)("".concat(this.site,"/api/Book/").concat(l,"/book-page?page=").concat(u),{headers:t})];case 2:return[4,n.sent().text()];case 3:return[2,n.sent()]}}))}))},p.prototype.searchNovels=function(r,a){return t(this,void 0,void 0,(function(){var t,a,i,o,l,c,h=this;return n(this,(function(n){switch(n.label){case 0:return(t=r.trim())?[4,this.ensureToken()]:[2,[]];case 1:return n.sent(),a="".concat(this.baseUrl,"/api/Search/search")+"?queryString=".concat(encodeURIComponent(t))+"&includeChapterAndFiles=false",[4,(0,s.fetchApi)(a,{method:"GET",headers:e({Accept:"application/json"},this.getAuthHeaders())})];case 2:return[4,n.sent().text()];case 3:i=n.sent();try{o=JSON.parse(i)}catch(e){return[2,[]]}return l=(null==o?void 0:o.series)||(null==o?void 0:o.seriesResults)||(null==o?void 0:o.seriesDtos)||[],c=l.map((function(e){var t,n,r,a=null!==(t=e.seriesId)&&void 0!==t?t:e.id,i=null!==(r=null!==(n=e.name)&&void 0!==n?n:e.seriesName)&&void 0!==r?r:"Unknown series",s=a?"".concat(h.baseUrl,"/api/image/series-cover?seriesId=").concat(a).concat(h.apiKey?"&apiKey=".concat(h.apiKey):""):u.defaultCover;return{name:i,path:String(a),cover:s}})),[2,c]}}))}))},p}();exports.default=new p;